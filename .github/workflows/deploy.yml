name: CI/CD Gestion de Items

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_PATH: /home/ubuntu/gestion-items
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  test:
    name: Ejecutar Tests
    runs-on: ubuntu-latest

    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Instalar dependencias
        working-directory: ./backend
        run: npm ci

      - name: Ejecutar tests
        working-directory: ./backend
        run: npm test

  build-images:
    name: Construir y Subir Imagenes Docker a Docker Hub
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in a Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Construir y etiquetar imagen Frontend
        run: |
          cd frontend
          docker build -t ${{ env.DOCKERHUB_USER }}/frontend-app:latest \
                       -t ${{ env.DOCKERHUB_USER }}/frontend-app:${{ github.sha }} .
          echo " Imagen Frontend construida y etiquetada"

      - name: Construir y etiquetar imagen Backend
        run: |
          cd backend
          docker build -t ${{ env.DOCKERHUB_USER }}/backend-api:latest \
                       -t ${{ env.DOCKERHUB_USER }}/backend-api:${{ github.sha }} .
          echo " Imagen Backend construida y etiquetada"

      - name: Push de imagenes a Docker Hub
        run: |
          docker push ${{ env.DOCKERHUB_USER }}/frontend-app:latest
          docker push ${{ env.DOCKERHUB_USER }}/frontend-app:${{ github.sha }}

          docker push ${{ env.DOCKERHUB_USER }}/backend-api:latest
          docker push ${{ env.DOCKERHUB_USER }}/backend-api:${{ github.sha }}

          echo "ðŸš€ Imagenes subidas a Docker Hub correctamente"

  deploy:
    name: Desplegar en EC2
    runs-on: ubuntu-latest
    needs: [test, build-images]

    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar conexion SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Probar conexion SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'echo "âœ… Conexion SSH exitosa"'

      - name: Actualizar ahora las imÃ¡genes desde Docker Hub
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "docker pull ${{ env.DOCKERHUB_USER }}/frontend-app:latest"
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "docker pull ${{ env.DOCKERHUB_USER }}/backend-api:latest"
          echo "ðŸ“¦ Imagenes actualizadas desde Docker Hub"

      - name: Actualizar codigo en EC2
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ env.PROJECT_PATH }} && git pull origin main && echo 'âœ… Codigo actualizado'"

      - name: Actualizar variables de entorno
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ env.PROJECT_PATH }} && echo 'REACT_APP_API_URL=http://${{ secrets.SSH_HOST }}:5000/api' > frontend/.env"
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ env.PROJECT_PATH }} && printf 'PORT=5000\nNODE_ENV=production\nDB_HOST=postgres\nDB_PORT=5432\nDB_NAME=cruddb\nDB_USER=postgres\nDB_PASSWORD=${{ secrets.DB_PASSWORD }}' > backend/.env"
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'âœ… Variables de entorno actualizadas'"

      - name: Detener contenedores
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ env.PROJECT_PATH }} && docker compose -f docker-compose.prod.yml down"

      - name: Levantar contenedores usando las imagenes desde Docker Hub
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ env.PROJECT_PATH }} && docker compose -f docker-compose.prod.yml up -d"
          echo "ðŸš€ Nuevas imagenes desde Docker Hub desplegadas correctamente"

      - name: Verificar deployment
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "curl -f http://localhost:5000/health"
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'ðŸš€ Deployment exitoso!'"
