name: CI/CD Gestion de Items

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_PATH: /home/ubuntu/gestion-items

jobs:
  test:
    name: Ejecutar Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Instalar dependencias
        working-directory: ./backend
        run: npm ci

      - name: Ejecutar tests
        working-directory: ./backend
        run: npm test

  build-images:
    name: Construir Imagenes Docker
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Construir imagen Frontend
        run: |
          cd frontend
          docker build -t frontend-app:${{ github.sha }} .
          echo " Imagen Frontend construida"

      - name: Construir imagen Backend
        run: |
          cd backend
          docker build -t backend-api:${{ github.sha }} .
          echo " Imagen Backend construida"

  deploy:
    name: Desplegar en EC2
    runs-on: ubuntu-latest
    needs: [test, build-images]
    
    steps:
      - name: Descargar codigo
        uses: actions/checkout@v4

      - name: Configurar conexion SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Probar conexion SSH
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'echo "‚úÖ Conexion SSH exitosa"'

      - name: Actualizar codigo en EC2
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            git pull origin main
            echo "‚úÖ Codigo actualizado"
          EOF

      - name: Actualizar variables de entorno
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            echo " Actualizando archivos .env..."

            cat > frontend/.env << 'ENVFILE'
          REACT_APP_API_URL=http://${{ secrets.SSH_HOST }}:5000/api
          ENVFILE
            
            cat > backend/.env << 'ENVFILE'
          PORT=5000
          NODE_ENV=production
          DB_HOST=postgres
          DB_PORT=5432
          DB_NAME=cruddb
          DB_USER=postgres
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          ENVFILE
            
            echo "‚úÖ Variables de entorno actualizadas"
          EOF

      - name: Detener contenedores
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            echo "üõë Deteniendo contenedores..."
            docker compose -f docker-compose.prod.yml down
            echo "‚úÖ Contenedores detenidos"
          EOF

      - name: Construir imagenes en servidor
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            docker compose -f docker-compose.prod.yml build --no-cache
            echo " Imagenes construidas"
          EOF

      - name: Iniciar contenedores
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            docker compose -f docker-compose.prod.yml up -d
            sleep 30
            echo "‚úÖ Contenedores iniciados"
          EOF

      - name: Verificar deployment
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            docker ps
            
            if curl -f http://localhost:5000/health > /dev/null 2>&1; then
              echo "‚úÖ Backend funcionando"
            else
              echo "‚ùå Backend no responde"
              exit 1
            fi
            
            if curl -f http://localhost:80 > /dev/null 2>&1; then
              echo "‚úÖ Frontend accesible"
            else
              echo "‚ùå Frontend no accesible"
              exit 1
            fi
            
            echo " Deployment exitoso!"
          EOF

      - name: Mostrar logs
        if: always()
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}
            echo " Logs recientes:"
            docker compose -f docker-compose.prod.yml logs --tail=20
          EOF

      - name: Resumen del deployment
        run: |
          echo " Deployment completado!"
          echo " Frontend: http://${{ secrets.SSH_HOST }}"
          echo " Backend: http://${{ secrets.SSH_HOST }}:5000/api/items"
          echo " Health: http://${{ secrets.SSH_HOST }}:5000/health"